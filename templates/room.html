{% extends 'base.html' %}
{% block content %}
<body>
    <div class="message-box">
        <h2>Chat Room: {{code}}</h2>
        <div class="messages" id="messages"></div>
        <div class="inputs">
            <!-- Recipient selection dropdown -->
            <select id="recipient">
                <option value="everyone">Everyone</option>
                <!-- Options for other users will be populated dynamically -->
            </select>
            <input 
                type="text" 
                placeholder="Message" 
                name="message" 
                id="message" 
            />
            <button class="buttonRight" type="button" name="send" id="send-btn" onClick="sendMessage()">
                Send
            </button>
        </div>
    </div>

    <!-- Include Socket.IO library -->
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>

    <script>
        var socketio = io();
        let counter = 0; // Initialize counter
        let privateKey;
        let publicKeyPem;
        let clientsPublicKeys = {}; // Store public keys of other clients
        let name = "{{ session.get('name') }}"; // Get current user's name

        // Function to update recipient list
        function updateRecipientList(clients) {
            const recipientSelect = document.getElementById('recipient');
            // Clear existing options except 'Everyone'
            recipientSelect.innerHTML = '<option value="everyone">Everyone</option>';
            clients.forEach(client => {
                if (client.name !== name) { // Exclude self
                    const option = document.createElement('option');
                    option.value = client.name;
                    option.textContent = client.name;
                    recipientSelect.appendChild(option);
                }
            });
        }

        // Listen for client list updates from the server
        socketio.on('client_list_update', (data) => {
            // Update clientsPublicKeys and recipient list
            clientsPublicKeys = data.clientsPublicKeys;
            updateRecipientList(data.clients);
        });

        // Function to create a message in the chat window
        function createMessage(senderName, msg, isWhisper = false) {
            const content = `
            <div class="text ${isWhisper ? 'whisper' : ''}">
                <span>
                    <strong>${senderName}${isWhisper ? ' (whisper)' : ''}</strong>: ${msg}
                </span>
                <span class="muted">
                    ${new Date().toLocaleString()}
                </span>
            </div>
            `;

            const messages = document.getElementById("messages");
            messages.innerHTML += content;
            messages.scrollTop = messages.scrollHeight; // Auto-scroll to the bottom
        }

        // Function to send a message
        async function sendMessage() {
            const messageInput = document.getElementById("message");
            const recipientSelect = document.getElementById("recipient");
            const recipient = recipientSelect.value;

            if (messageInput.value === "") {
                return;
            }

            counter++; // Increment the counter

            if (recipient === "everyone") {
                // Send public message
                const data = {
                    "type": "public_chat",
                    "sender": name,
                    "message": messageInput.value
                };

                // Send the message to the server
                socketio.emit("public_message", data);
            } else {
                // Send encrypted whisper message
                // For now, we'll just simulate sending a whisper
                const data = {
                    "type": "chat",
                    "sender": name,
                    "recipient": recipient,
                    "message": messageInput.value
                };

                // Send the message to the server
                socketio.emit("chat_message", data);
            }

            messageInput.value = "";
        }

        // Handle received public messages
        socketio.on("public_message", (data) => {
            createMessage(data.sender, data.message);
        });

        // Handle received chat messages (whispers)
        socketio.on("chat_message", (data) => {
            if (data.recipient === name || data.sender === name) {
                createMessage(data.sender, data.message, true);
            }
        });

        // Load previous messages (if any)
        {% for msg in messages %}
            createMessage("{{msg.name}}", "{{msg.message}}");
        {% endfor %}

        // Handle 'Enter' key press to send message
        var input = document.getElementById("message");
        input.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                sendMessage();
            }
        });
    </script>

    <!-- Include some CSS to style whispers differently -->
    <style>
        .message-box {
            width: 60%;
            margin: 0 auto;
            padding: 10px;
        }
        .messages {
            height: 400px;
            overflow-y: scroll;
            border: 1px solid #ddd;
            padding: 5px;
            margin-bottom: 10px;
            background-color: black;
        }
        .inputs {
            display: flex;
            align-items: center;
        }
        .inputs select, .inputs input[type="text"] {
            flex: 1;
            margin-right: 5px;
            padding: 8px;
        }
        .inputs button {
            padding: 8px 12px;
        }
        .text {
            margin-bottom: 10px;
        }
        .text .muted {
            font-size: 0.8em;
            color: #888;
            margin-left: 10px;
        }
        .whisper {
            font-style: italic;
            color: gray;
        }
    </style>
</body>
{% endblock %}
