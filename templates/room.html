{% extends 'base.html' %} {% block content %}
<body>
    <div class="message-box">
        <h2>Chat Room: {{code}}</h2>
        <div class="messages" id="messages"></div>
        <div class="inputs">
            <input 
                type="text" 
                placeholder="Message" 
                name="message" 
                id="message" 
            />
            <button class="buttonRight" type="button" name="send" id="send-btn" onClick="sendMessage()">
                Send
            </button>
        </div>
    </div>

    <!-- Include Socket.IO library -->
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>

    <script>
        var socketio = io();
        let counter = 0; // Initialize counter
        let privateKey;
        let publicKeyPem;

        // Helper function to convert ArrayBuffer to Base64 string
        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        // Helper function to format PEM string
        function formatPEM(pem) {
            const pemHeader = "-----BEGIN PUBLIC KEY-----\n";
            const pemFooter = "\n-----END PUBLIC KEY-----";
            const pemBody = pem.match(/.{1,64}/g).join('\n');
            return pemHeader + pemBody + pemFooter;
        }

        // Deterministic JSON stringify function
        function deterministicStringify(obj) {
            const replacer = (key, value) => {
                if (value && typeof value === 'object' && !Array.isArray(value)) {
                    const sortedObj = {};
                    Object.keys(value).sort().forEach((k) => {
                        sortedObj[k] = value[k];
                    });
                    return sortedObj;
                }
                return value;
            };
            return JSON.stringify(obj, replacer);
        }

        // Function to generate RSA key pair
        async function generateKeys() {
            const keyPair = await window.crypto.subtle.generateKey(
                {
                    name: "RSA-PSS",
                    modulusLength: 2048,
                    publicExponent: new Uint8Array([1, 0, 1]),
                    hash: "SHA-256",
                },
                true,
                ["sign", "verify"]
            );

            privateKey = keyPair.privateKey;
            const exportedPublicKey = await window.crypto.subtle.exportKey(
                "spki",
                keyPair.publicKey
            );
            const exportedAsBase64 = arrayBufferToBase64(exportedPublicKey);
            publicKeyPem = formatPEM(exportedAsBase64);
        }

        // Function to sign data
        async function signData(data) {
            const encoder = new TextEncoder();
            const dataString = deterministicStringify(data); // Use deterministic JSON
            const dataToSign = encoder.encode(dataString + counter);
            console.log("Data to Sign:", dataString + counter);
            const signature = await window.crypto.subtle.sign(
                {
                    name: "RSA-PSS",
                    saltLength: 32,
                },
                privateKey,
                dataToSign
            );
            return arrayBufferToBase64(signature);
        }

        // Send 'hello' message to server
        async function sendHello() {
            counter++; // Increment counter for the hello message

            const data = {
                "public_key": publicKeyPem,
                "type": "hello"
            };

            const signature = await signData(data);

            const helloPayload = {
                "data": data,
                "counter": counter,
                "signature": signature
            };

            console.log("Sending hello payload:", helloPayload);

            socketio.emit('hello', helloPayload);
        }

        socketio.on('connect', async () => {
            console.log("Socket connected:", socketio.connected);
            await generateKeys();
            await sendHello();
        });

        const messages = document.getElementById("messages");

        function createMessage(name, msg) {
            const content = `
            <div class="text">
                <span>
                    <strong>${name}</strong>: ${msg}
                </span>
                <span class="muted">
                    ${new Date().toLocaleString()}
                </span>
            </div>
            `;

            messages.innerHTML += content;
            messages.scrollTop = messages.scrollHeight; // Auto-scroll to the bottom
        }

        // Listen for message events from the server
        socketio.on("message", (data) => {
            console.log("Received message:", data);
            createMessage(data.name, data.message);
        });

        // Declare sendMessage as a function in the global scope
        async function sendMessage() {
            console.log("sendMessage function called");
            const messageInput = document.getElementById("message");
            if (messageInput.value === "") {
                console.log("Message input is empty. Exiting sendMessage.");
                return;
            }

            counter++; // Increment the counter

            const data = {
                "message": messageInput.value,
                "type": "chat"
            };

            const signature = await signData(data);

            const messagePayload = {
                "data": data,
                "counter": counter,
                "signature": signature
            };

            console.log("Sending message payload:", messagePayload);

            socketio.emit("message", messagePayload);
            messageInput.value = "";
        }

        // Handle 'Enter' key press to send message
        var input = document.getElementById("message");
        input.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                console.log("Enter key pressed");
                sendMessage();
            }
        });

        // Load previous messages
        {% for msg in messages %}
            createMessage("{{msg.name}}", "{{msg.message}}");
        {% endfor %}
    </script>
</body>
{% endblock %}
